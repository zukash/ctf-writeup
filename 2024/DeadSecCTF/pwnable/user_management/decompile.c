/* This file was generated by the Hex-Rays decompiler version 8.4.0.240320.
   Copyright (c) 2007-2021 Hex-Rays <info@hex-rays.com>

   Detected compiler: GNU C++
*/

#include <defs.h>

//-------------------------------------------------------------------------
// Function declarations

__int64 (**init_proc())(void);
void sub_1020();
// int putchar(int c);
// int strncmp(const char *s1, const char *s2, size_t n);
// void __noreturn _exit(int status);
// int puts(const char *s);
// char *strchr(const char *s, int c);
// int printf(const char *format, ...);
// unsigned int alarm(unsigned int seconds);
// int close(int fd);
// ssize_t read(int fd, void *buf, size_t nbytes);
// void srand(unsigned int seed);
// char *fgets(char *s, int n, FILE *stream);
// int strcmp(const char *s1, const char *s2);
// int getchar(void);
// __sighandler_t signal(int sig, __sighandler_t handler);
// int setvbuf(FILE *stream, char *buf, int modes, size_t n);
// int open(const char *file, int oflag, ...);
// void perror(const char *s);
// __int64 __isoc99_scanf(const char *, ...); weak
// void __noreturn exit(int status);
// int rand(void);
// int __fastcall _cxa_finalize(void *);
void __fastcall __noreturn start(__int64 a1, __int64 a2, void (*a3)(void));
void *sub_11C0();
__int64 sub_11F0();
void *sub_1230();
__int64 sub_1270();
int sub_1279();
int sub_1479();
void __fastcall handler(int a1);  // idb
unsigned int sub_152F();
void init();
unsigned __int64 login_as_admin();
int create_user();
unsigned __int64 login_as_user();
unsigned __int64 view_description();
int menu();
void term_proc();
// int __fastcall _libc_start_main(int (__fastcall *main)(int, char **, char
// **), int argc, char **ubp_av, void (*init)(void), void (*fini)(void), void
// (*rtld_fini)(void), void *stack_end); int __fastcall __cxa_finalize(void *);
// __int64 _gmon_start__(void); weak

//-------------------------------------------------------------------------
// Data declarations

_UNKNOWN main;
void *off_5008 = &off_5008;  // idb
int loginId = -2;            // weak
int dword_5014 = 1;          // weak
_UNKNOWN unk_5018;           // weak
FILE *stdout;                // idb
FILE *stdin;                 // idb
FILE *stderr;                // idb
char byte_5048;              // weak
char byte_5060[732];         // weak
int dword_533C;              // weak
char s1[16];                 // idb
char byte_5350[8];           // idb
char byte_5358;              // idb
char byte_5359;              // weak
char byte_535A;              // weak
char byte_535B;              // weak
char byte_535C;              // weak
char byte_535D;              // weak
char byte_535E;              // weak
char byte_535F;              // weak

//----- (0000000000001000) ----------------------------------------------------
__int64 (**init_proc())(void) {
  __int64 (**result)(void);  // rax

  result = &_gmon_start__;
  if (&_gmon_start__) return (__int64 (**)(void))_gmon_start__();
  return result;
}
// 5420: using guessed type __int64 _gmon_start__(void);

//----- (0000000000001020) ----------------------------------------------------
void sub_1020() { JUMPOUT(0LL); }
// 1026: control flows out of bounds to 0

//----- (0000000000001190) ----------------------------------------------------
// positive sp value has been detected, the output may be wrong!
void __fastcall __noreturn start(__int64 a1, __int64 a2, void (*a3)(void)) {
  __int64 v3;     // rax
  int v4;         // esi
  __int64 v5;     // [rsp-8h] [rbp-8h] BYREF
  char *retaddr;  // [rsp+0h] [rbp+0h] BYREF

  v4 = v5;
  v5 = v3;
  _libc_start_main((int(__fastcall *)(int, char **, char **))main, v4, &retaddr,
                   0LL, 0LL, a3, &v5);
  __halt();
}
// 1196: positive sp value 8 has been found
// 119D: variable 'v3' is possibly undefined

//----- (00000000000011C0) ----------------------------------------------------
void *sub_11C0() { return &unk_5018; }

//----- (00000000000011F0) ----------------------------------------------------
__int64 sub_11F0() { return 0LL; }

//----- (0000000000001230) ----------------------------------------------------
void *sub_1230() {
  void *result;  // rax

  if (!byte_5048) {
    if (&__cxa_finalize) _cxa_finalize(off_5008);
    result = sub_11C0();
    byte_5048 = 1;
  }
  return result;
}
// 5048: using guessed type char byte_5048;

//----- (0000000000001270) ----------------------------------------------------
// attributes: thunk
__int64 sub_1270() { return sub_11F0(); }

//----- (0000000000001279) ----------------------------------------------------
int sub_1279() {
  printf("\x1B[1;36m");
  putchar(10);
  puts(" _____ _   _ _____   _   _ _   _____ ____      _    ");
  puts("|_   _| | | | ____| | | | | | |_   _|  _ \\    / \\   ");
  puts("  | | | |_| |  _|   | | | | |   | | | |_) |  / _ \\  ");
  puts("  | | |  _  | |___  | |_| | |___| | |  _ <  / ___ \\ ");
  puts("  |_| |_| |_|_____|  \\___/|_____|_| |_| \\_\\/_/   \\_\\");
  puts("                                                    ");
  puts(" ____  _   _ ____  _____ ____    ____  _____ ____ _   _ ____  _____ ");
  puts(
      "/ ___|| | | |  _ \\| ____|  _ \\  / ___|| ____/ ___| | | |  _ \\| "
      "____|");
  puts(
      "\\___ \\| | | | |_) |  _| | |_) | \\___ \\|  _|| |   | | | | |_) |  _| "
      " ");
  puts(" ___) | |_| |  __/| |___|  _ <   ___) | |__| |___| |_| |  _ <| |___ ");
  puts(
      "|____/ \\___/|_|   |_____|_| \\_\\ |____/|_____\\____|\\___/|_| "
      "\\_\\_____|");
  puts("                                                                    ");
  puts(" _   _ ____  _____ ____  ");
  puts("| | | / ___|| ____|  _ \\ ");
  puts("| | | \\___ \\|  _| | |_) |");
  puts("| |_| |___) | |___|  _ < ");
  puts(" \\___/|____/|_____|_| \\_\\");
  puts("                         ");
  puts(" __  __    _    _   _    _    ____ _____ __  __ _____ _   _ _____ ");
  puts(
      "|  \\/  |  / \\  | \\ | |  / \\  / ___| ____|  \\/  | ____| \\ | |_   "
      "_|");
  puts(
      "| |\\/| | / _ \\ |  \\| | / _ \\| |  _|  _| | |\\/| |  _| |  \\| | | | "
      " ");
  puts(
      "| |  | |/ ___ \\| |\\  |/ ___ \\ |_| | |___| |  | | |___| |\\  | | |  ");
  puts(
      "|_|  |_/_/   \\_\\_| \\_/_/   \\_\\____|_____|_|  |_|_____|_| \\_| |_| "
      " ");
  puts("                                                                  ");
  puts(" ______   ______ _____ _____ __  __ ");
  puts("/ ___\\ \\ / / ___|_   _| ____|  \\/  |");
  puts("\\___ \\\\ V /\\___ \\ | | |  _| | |\\/| |");
  puts(" ___) || |  ___) || | | |___| |  | |");
  puts("|____/ |_| |____/ |_| |_____|_|  |_|");
  putchar(10);
  putchar(10);
  return printf("\x1B[0m");
}

//----- (0000000000001479) ----------------------------------------------------
int sub_1479() {
  setvbuf(stdout, 0LL, 2, 0LL);
  setvbuf(stdin, 0LL, 2, 0LL);
  return setvbuf(stderr, 0LL, 2, 0LL);
}

//----- (00000000000014DA) ----------------------------------------------------
void __fastcall handler(int a1) {
  if (a1 == 14) {
    printf("\x1B[1;31m");
    puts("You took too long ma friend");
    printf("\x1B[0m");
    _exit(0);
  }
}

//----- (000000000000152F) ----------------------------------------------------
unsigned int sub_152F() {
  signal(14, handler);
  return alarm(0x1Eu);
}

//----- (0000000000001554) ----------------------------------------------------
void init() {
  unsigned int buf;  // [rsp+8h] [rbp-8h] BYREF
  int fd;            // [rsp+Ch] [rbp-4h]

  sub_1479();
  sub_152F();
  sub_1279();
  fd = open("/dev/random", 0);
  if (fd == -1) {
    perror("Error opening /dev/random");
    exit(1);
  }
  byte_535F = 81;
  byte_535C = 112;
  byte_535A = 65;
  byte_535E = 97;
  if (read(fd, &buf, 4uLL) != 4) {
    perror("Error reading from /dev/random");
    exit(1);
  }
  byte_5358 = 77;
  byte_535B = 108;
  byte_535D = 104;
  byte_5359 = 114;
  close(fd);
  srand(buf);
}
// 5359: using guessed type char byte_5359;
// 535A: using guessed type char byte_535A;
// 535B: using guessed type char byte_535B;
// 535C: using guessed type char byte_535C;
// 535D: using guessed type char byte_535D;
// 535E: using guessed type char byte_535E;
// 535F: using guessed type char byte_535F;

//----- (0000000000001659) ----------------------------------------------------
unsigned __int64 login_as_admin() {
  int i;                // [rsp+Ch] [rbp-44h]
  char v2[32];          // [rsp+10h] [rbp-40h] BYREF
  char s1[24];          // [rsp+30h] [rbp-20h] BYREF
  unsigned __int64 v4;  // [rsp+48h] [rbp-8h]

  v4 = __readfsqword(0x28u);
  for (i = 0; i <= 7; ++i) byte_5350[i] = rand();
  puts("what do you want to do here?");
  fgets(::s1, 21, stdin);
  if (!strncmp(::s1, "manage users", 0xCuLL)) {
    printf("Enter username: ");
    __isoc99_scanf("%19s", v2);
    printf("Enter password: ");
    __isoc99_scanf("%19s", s1);
    if (!strcmp(s1, byte_5350) && !strcmp(v2, &byte_5358)) {
      loginId = -1;
      printf("\x1B[1;32m");
      puts("Logged in as admin");
      printf("\x1B[0m");
    } else {
      printf("\x1B[1;31m");
      puts("Wrong username or password");
      printf("\x1B[0m");
    }
  } else {
    printf("\x1B[1;31m");
    puts("You are not allowed to do that!!");
    printf("\x1B[0m");
  }
  return v4 - __readfsqword(0x28u);
}
// 1150: using guessed type __int64 __isoc99_scanf(const char *, ...);
// 5010: using guessed type int loginId;

//----- (0000000000001848) ----------------------------------------------------
int create_user() {
  int i;  // [rsp+Ch] [rbp-4h]

  if (loginId == -1) {
    if (dword_533C > 1) {
      printf("\x1B[1;31m");
      puts("No more space for users");
      return printf("\x1B[0m");
    } else {
      printf("Enter username: ");
      fgets(&byte_5060[365 * dword_533C], 30, stdin);
      printf("Enter password: ");
      fgets(&byte_5060[365 * dword_533C + 30], 30, stdin);
      printf("Enter description: ");
      fgets(&byte_5060[365 * dword_533C + 60], 305, stdin);
      for (i = 0; i < dword_533C; ++i) {
        if (!strcmp(&byte_5060[365 * i], &byte_5060[365 * dword_533C])) {
          printf("\x1B[1;31m");
          puts("User already exists");
          return printf("\x1B[0m");
        }
      }
      printf("\x1B[1;32m");
      puts("User created successfully");
      printf("\x1B[0m");
      return ++dword_533C;
    }
  } else {
    printf("\x1B[1;31m");
    puts("You need to be logged in as admin to create a new user");
    return printf("\x1B[0m");
  }
}
// 5010: using guessed type int loginId;
// 533C: using guessed type int dword_533C;

//----- (0000000000001B0B) ----------------------------------------------------
unsigned __int64 login_as_user() {
  int i;                // [rsp+Ch] [rbp-54h]
  char s[32];           // [rsp+10h] [rbp-50h] BYREF
  char s2[40];          // [rsp+30h] [rbp-30h] BYREF
  unsigned __int64 v4;  // [rsp+58h] [rbp-8h]

  v4 = __readfsqword(0x28u);
  if (loginId == -2) {
    printf("Enter username: ");
    fgets(s, 30, stdin);
    printf("Enter password: ");
    fgets(s2, 30, stdin);
    for (i = 0; i <= 1; ++i) {
      if (!strcmp(&byte_5060[365 * i], s) &&
          !strcmp(&byte_5060[365 * i + 30], s2)) {
        loginId = i;
        printf("\x1B[1;32m");
        printf("Logged in as %s\n", s);
        printf("\x1B[0m");
        return v4 - __readfsqword(0x28u);
      }
    }
    printf("\x1B[1;31m");
    puts("Wrong username or password");
    printf("\x1B[0m");
  } else {
    printf("\x1B[1;31m");
    puts("You are already logged in");
    printf("\x1B[0m");
  }
  return v4 - __readfsqword(0x28u);
}
// 5010: using guessed type int loginId;

//----- (0000000000001D00) ----------------------------------------------------
unsigned __int64 view_description() {
  char s[312];          // [rsp+0h] [rbp-140h] BYREF
  unsigned __int64 v2;  // [rsp+138h] [rbp-8h]

  v2 = __readfsqword(0x28u);
  if ((unsigned int)loginId < 0xFFFFFFFE) {
    qmemcpy(s, &byte_5060[365 * loginId + 60], 0x131uLL);
    if (strchr(s, 36)) {
      puts("fr!? what is this description dude??");
    } else {
      printf("The description for: ");
      printf(&byte_5060[365 * loginId]);
      printf(" is: ");
      printf(s);
      putchar(10);
    }
  } else {
    printf("\x1B[1;31m");
    puts("You need to be logged in to see the description");
    printf("\x1B[0m");
  }
  return v2 - __readfsqword(0x28u);
}
// 5010: using guessed type int loginId;

//----- (0000000000001E89) ----------------------------------------------------
int menu() {
  puts("1. Admin login");
  puts("2. Create user");
  puts("3. Login as user");
  puts("4. Logout");
  puts("5. View description");
  return puts("6. Exit");
}

//----- (0000000000001EEA) ----------------------------------------------------
__int64 __fastcall main(int a1, char **a2, char **a3) {
  int v4;  // [rsp+Ch] [rbp-4h] BYREF

  init();
  while (dword_5014) {
    menu();
    printf("Enter choice: ");
    __isoc99_scanf("%1d", &v4);
    while (getchar() != 10);
    switch (v4) {
      case 1:
        login_as_admin();
        break;
      case 2:
        create_user();
        break;
      case 3:
        login_as_user();
        break;
      case 4:
        if (loginId == -2) {
          printf("\x1B[1;31m");
          puts("You are not logged in");
        } else {
          loginId = -2;
          printf("\x1B[1;32m");
          puts("Logged out");
        }
        printf("\x1B[0m");
        break;
      case 5:
        view_description();
        break;
      case 6:
        printf("\x1B[1;32m");
        puts("see ya later");
        printf("\x1B[0m");
        dword_5014 = 0;
        break;
      default:
        printf("\x1B[1;31m");
        puts("Invalid choice");
        printf("\x1B[0m");
        break;
    }
  }
  return 0LL;
}
// 1150: using guessed type __int64 __isoc99_scanf(const char *, ...);
// 5010: using guessed type int loginId;
// 5014: using guessed type int dword_5014;

//----- (00000000000020C8) ----------------------------------------------------
void term_proc() { ; }

// nfuncs=65 queued=19 decompiled=19 lumina nreq=0 worse=0 better=0
// ALL OK, 19 function(s) have been successfully decompiled
