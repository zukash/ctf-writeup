/* This file was generated by the Hex-Rays decompiler version 8.4.0.240320.
   Copyright (c) 2007-2021 Hex-Rays <info@hex-rays.com>

   Detected compiler: GNU C++
*/

#include <defs.h>

//-------------------------------------------------------------------------
// Function declarations

__int64 (**init_proc())(void);
void sub_1020();
void sub_1030();
void sub_1040();
void sub_1050();
void sub_1060();
void sub_1070();
void sub_1080();
void sub_1090();
void sub_10A0();
void sub_10B0();
void sub_10C0();
void sub_10D0();
void sub_10E0();
void sub_10F0();
// int __fastcall _cxa_finalize(void *);
// int strncmp(const char *s1, const char *s2, size_t n);
// int puts(const char *s);
// int system(const char *command);
// int printf(const char *format, ...);
// void *memset(void *s, int c, size_t n);
// size_t strnlen(const char *string, size_t maxlen);
// void *calloc(size_t nmemb, size_t size);
// __int64 strtol(const char *nptr, char **endptr, int base);
// void *memcpy(void *dest, const void *src, size_t n);
// int setvbuf(FILE *stream, char *buf, int modes, size_t n);
// __int64 __isoc99_scanf(const char *, ...); weak
// __int64 __fastcall getrandom(_QWORD, _QWORD, _QWORD); weak
void __fastcall __noreturn start(__int64 a1, __int64 a2, void (*a3)(void));
void *deregister_tm_clones();
__int64 register_tm_clones();
void *_do_global_dtors_aux();
__int64 frame_dummy();  // weak
__int64 check_password();
__int64 __fastcall init_cand(__int64 a1, __int64 a2, char a3);
unsigned __int64 __fastcall vote_printer_selector(__int64 a1);
int __fastcall change_password_to(const char *a1);
unsigned __int64 __fastcall simple_vote_printer(__int64 a1);
unsigned __int64 __fastcall total_vote_printer(__int64 a1);
int __fastcall debug_cand_printer(__int64 a1);
__int64 __fastcall menu(const char *a1, const char *a2, int a3);
unsigned __int64 __fastcall print_int_with_commas(__int64 a1, int a2,
                                                  unsigned int a3);
int __fastcall main(int argc, const char **argv, const char **envp);
__int64 __fastcall print_status(__int64 a1);
__int64 add_votes_menu();
unsigned __int64 set_new_password();
int close_voting();
void __noreturn main_menu();
void term_proc();
// int __fastcall _libc_start_main(int (__fastcall *main)(int, char **, char
// **), int argc, char **ubp_av, void (*init)(void), void (*fini)(void), void
// (*rtld_fini)(void), void *stack_end); int __fastcall __cxa_finalize(void *);
// __int64 _gmon_start__(void); weak

//-------------------------------------------------------------------------
// Data declarations

void *__ptr32 off_325E = &loc_203E;                                    // weak
const char byte_3451[7] = {'\0', '\0', '\0', '\0', '\0', '\0', '\0'};  // idb
void *_dso_handle = &_dso_handle;                                      // idb
_UNKNOWN _bss_start;                                                   // weak
FILE *stdout;                                                          // idb
FILE *stdin;                                                           // idb
FILE *stderr;                                                          // idb
char completed_0;                                                      // weak
__int64 cand_array;                                                    // weak
__int64 num_cands;                                                     // weak
char password[16];                                                     // idb

//----- (0000000000001000) ----------------------------------------------------
__int64 (**init_proc())(void) {
  __int64 (**result)(void);  // rax

  result = &_gmon_start__;
  if (&_gmon_start__) return (__int64 (**)(void))_gmon_start__();
  return result;
}
// 50F8: using guessed type __int64 _gmon_start__(void);

//----- (0000000000001020) ----------------------------------------------------
void sub_1020() { JUMPOUT(0LL); }
// 1026: control flows out of bounds to 0

//----- (0000000000001030) ----------------------------------------------------
void sub_1030() { sub_1020(); }

//----- (0000000000001040) ----------------------------------------------------
void sub_1040() { sub_1020(); }

//----- (0000000000001050) ----------------------------------------------------
void sub_1050() { sub_1020(); }

//----- (0000000000001060) ----------------------------------------------------
void sub_1060() { sub_1020(); }

//----- (0000000000001070) ----------------------------------------------------
void sub_1070() { sub_1020(); }

//----- (0000000000001080) ----------------------------------------------------
void sub_1080() { sub_1020(); }

//----- (0000000000001090) ----------------------------------------------------
void sub_1090() { sub_1020(); }

//----- (00000000000010A0) ----------------------------------------------------
void sub_10A0() { sub_1020(); }

//----- (00000000000010B0) ----------------------------------------------------
void sub_10B0() { sub_1020(); }

//----- (00000000000010C0) ----------------------------------------------------
void sub_10C0() { sub_1020(); }

//----- (00000000000010D0) ----------------------------------------------------
void sub_10D0() { sub_1020(); }

//----- (00000000000010E0) ----------------------------------------------------
void sub_10E0() { sub_1020(); }

//----- (00000000000010F0) ----------------------------------------------------
void sub_10F0() { sub_1020(); }

//----- (00000000000011E0) ----------------------------------------------------
// positive sp value has been detected, the output may be wrong!
void __fastcall __noreturn start(__int64 a1, __int64 a2, void (*a3)(void)) {
  __int64 v3;     // rax
  int v4;         // esi
  __int64 v5;     // [rsp-8h] [rbp-8h] BYREF
  char *retaddr;  // [rsp+0h] [rbp+0h] BYREF

  v4 = v5;
  v5 = v3;
  _libc_start_main((int(__fastcall *)(int, char **, char **))main, v4, &retaddr,
                   0LL, 0LL, a3, &v5);
  __halt();
}
// 11EA: positive sp value 8 has been found
// 11F1: variable 'v3' is possibly undefined

//----- (0000000000001210) ----------------------------------------------------
void *deregister_tm_clones() { return &_bss_start; }

//----- (0000000000001240) ----------------------------------------------------
__int64 register_tm_clones() { return 0LL; }

//----- (0000000000001280) ----------------------------------------------------
void *_do_global_dtors_aux() {
  void *result;  // rax

  if (!completed_0) {
    if (&__cxa_finalize) _cxa_finalize(_dso_handle);
    result = deregister_tm_clones();
    completed_0 = 1;
  }
  return result;
}
// 5048: using guessed type char completed_0;

//----- (00000000000012C0) ----------------------------------------------------
__int64 frame_dummy() { return register_tm_clones(); }
// 12C0: using guessed type __int64 frame_dummy();

//----- (00000000000012C9) ----------------------------------------------------
__int64 check_password() {
  char s1[24];          // [rsp+0h] [rbp-20h] BYREF
  unsigned __int64 v2;  // [rsp+18h] [rbp-8h]

  v2 = __readfsqword(0x28u);
  printf("Please enter the password\n> ");
  __isoc99_scanf("%16s", s1);
  if (!strncmp(s1, password, 0x10uLL)) {
    puts("Correct!");
    return 1LL;
  } else {
    puts("Incorrect.");
    return 0LL;
  }
}
// 11C0: using guessed type __int64 __isoc99_scanf(const char *, ...);

//----- (0000000000001372) ----------------------------------------------------
__int64 __fastcall init_cand(__int64 a1, __int64 a2, char a3) {
  __int64 result;  // rax
  __int64 i;       // [rsp+28h] [rbp-8h]

  for (i = 0LL; *(_BYTE *)(a2 + i); ++i)
    *(_BYTE *)(a1 + i) = *(_BYTE *)(a2 + i);
  *(_BYTE *)(a1 + 32) = a3;
  memset((void *)(a1 + 40), 0, 0x10uLL);
  result = a1;
  *(_QWORD *)(a1 + 56) = vote_printer_selector;
  return result;
}

//----- (0000000000001400) ----------------------------------------------------
unsigned __int64 __fastcall vote_printer_selector(__int64 a1) {
  if (*(_BYTE *)(a1 + 32) == 32)
    return total_vote_printer(a1);
  else
    return simple_vote_printer(a1);
}

//----- (0000000000001439) ----------------------------------------------------
int __fastcall change_password_to(const char *a1) {
  size_t v1;           // rax
  unsigned __int64 i;  // [rsp+18h] [rbp-8h]

  for (i = 0LL; i <= 0xF; ++i) password[i] = 0;
  v1 = strnlen(a1, 0x10uLL);
  memcpy(password, a1, v1);
  return puts("password change sucessful.");
}

//----- (00000000000014AC) ----------------------------------------------------
unsigned __int64 __fastcall simple_vote_printer(__int64 a1) {
  unsigned int v1;      // r13d
  int v2;               // eax
  double v4;            // [rsp+20h] [rbp-90h]
  _BYTE v5[70];         // [rsp+30h] [rbp-80h] BYREF
  char v6;              // [rsp+76h] [rbp-3Ah]
  unsigned __int64 v7;  // [rsp+78h] [rbp-38h]

  v7 = __readfsqword(0x28u);
  memset(v5, 42, sizeof(v5));
  v6 = 0;
  v4 = (double)*(int *)(a1 + 36) / (double)783926;
  v1 = *(char *)(a1 + 32);
  v2 = strnlen((const char *)a1, 0x20uLL);
  printf(
      "%s\n* Candidate: %s - %-*c *\n* Vote Tally: %-*.16s *\n* [%*.*s] "
      "(%6.2f%%) *\n*%*.0s*\n%s\n",
      v5, (const char *)a1, 70 - v2 - 18, v1, 54, (const char *)(a1 + 40), 54,
      (int)((double)54 * v4), v5, v4 * 100.0, 68, v5, v5);
  return v7 - __readfsqword(0x28u);
}

//----- (00000000000016AE) ----------------------------------------------------
unsigned __int64 __fastcall total_vote_printer(__int64 a1) {
  double v2;            // [rsp+20h] [rbp-60h]
  _BYTE v3[70];         // [rsp+30h] [rbp-50h] BYREF
  char v4;              // [rsp+76h] [rbp-Ah]
  unsigned __int64 v5;  // [rsp+78h] [rbp-8h]

  v5 = __readfsqword(0x28u);
  memset(v3, 42, sizeof(v3));
  v4 = 0;
  v2 = (double)*(int *)(a1 + 36) / (double)783926;
  printf("%s\n* Total Votes: %-*.16s *\n* [%*.*s] (%6.2f%%) *\n*%*.0s*\n%s\n",
         v3, 54, (const char *)(a1 + 40), 54, (int)((double)54 * v2), v3,
         v2 * 100.0, 68, v3, v3);
  return v5 - __readfsqword(0x28u);
}

//----- (0000000000001815) ----------------------------------------------------
int __fastcall debug_cand_printer(__int64 a1) {
  unsigned __int64 i;  // [rsp+18h] [rbp-18h]
  unsigned __int64 j;  // [rsp+20h] [rbp-10h]
  unsigned __int64 k;  // [rsp+28h] [rbp-8h]

  printf("Name:\t%s [", (const char *)a1);
  for (i = 0LL; i <= 0x1F; ++i) printf("%hhx", (unsigned int)*(char *)(a1 + i));
  puts("]");
  printf("Party:\t%c [%02hhx]\n", (unsigned int)*(char *)(a1 + 32),
         (unsigned int)*(char *)(a1 + 32));
  printf("Raw votes:\t%d [%x]\n", *(unsigned int *)(a1 + 36),
         *(unsigned int *)(a1 + 36));
  printf("Vote str:\t%s [", (const char *)(a1 + 40));
  for (j = 0LL; j <= 0xF; ++j)
    printf("%02hhx", (unsigned int)*(char *)(a1 + j + 40));
  puts("]");
  printf("func ptr: %p\n", *(const void **)(a1 + 56));
  puts("All as hex:");
  for (k = 0LL; k <= 0x3F; ++k)
    printf("%02hhx", (unsigned int)*(char *)(a1 + k));
  return puts("\n");
}

//----- (00000000000019C8) ----------------------------------------------------
__int64 __fastcall menu(const char *a1, const char *a2, int a3) {
  int v5;               // [rsp+24h] [rbp-5Ch]
  char nptr[72];        // [rsp+30h] [rbp-50h] BYREF
  unsigned __int64 v7;  // [rsp+78h] [rbp-8h]

  v7 = __readfsqword(0x28u);
  v5 = 0;
  printf("%s", a1);
  while (1) {
    if ((unsigned int)__isoc99_scanf("%63s", nptr)) v5 = strtol(nptr, 0LL, 10);
    if (v5 >= 1 && v5 <= a3) break;
    printf("%s", a2);
  }
  return (unsigned int)v5;
}
// 11C0: using guessed type __int64 __isoc99_scanf(const char *, ...);

//----- (0000000000001A9C) ----------------------------------------------------
unsigned __int64 __fastcall print_int_with_commas(__int64 a1, int a2,
                                                  unsigned int a3) {
  unsigned __int64 v5;  // [rsp+18h] [rbp-38h]
  __int64 v6;           // [rsp+20h] [rbp-30h]
  unsigned __int64 i;   // [rsp+28h] [rbp-28h]
  char v8[10];          // [rsp+3Eh] [rbp-12h]
  unsigned __int64 v9;  // [rsp+48h] [rbp-8h]

  v9 = __readfsqword(0x28u);
  v5 = 10LL;
  do {
    v8[--v5] = a3 % 0xA + 48;
    a3 /= 0xAu;
  } while (a3);
  v6 = 0LL;
  for (i = 0LL; i < a2 - (10 - (int)v5); ++i) *(_BYTE *)(a1 + v6++) = 32;
  while (v5 <= 9) {
    *(_BYTE *)(v6 + a1) = v8[v5];
    ++v6;
    ++v5;
    if (!((10 - v5) % 3) && v5 != 10) *(_BYTE *)(a1 + v6++) = 44;
  }
  return v9 - __readfsqword(0x28u);
}
// 1A9C: using guessed type char var_12[10];

//----- (0000000000001C07) ----------------------------------------------------
int __fastcall __noreturn main(int argc, const char **argv, const char **envp) {
  unsigned __int64 i;  // [rsp+8h] [rbp-8h]

  setvbuf(stdin, 0LL, 2, 0LL);
  setvbuf(stdout, 0LL, 2, 0LL);
  setvbuf(stderr, 0LL, 2, 0LL);
  for (i = 0LL; i <= 0xF; ++i) {
    while (!password[i]) getrandom(&password[i], 1LL, 0LL);
  }
  cand_array = (__int64)calloc(3uLL, 0x40uLL);
  init_cand(cand_array, (__int64)"Total", 32);
  init_cand(cand_array + 64, (__int64)"Wilfred J Lewis", 83);
  init_cand(cand_array + 128, (__int64)"Jeanette D Westcott", 84);
  num_cands = 3LL;
  main_menu();
}
// 11D0: using guessed type __int64 __fastcall getrandom(_QWORD, _QWORD,
// _QWORD); 5050: using guessed type __int64 cand_array; 5058: using guessed
// type __int64 num_cands;

//----- (0000000000001D4C) ----------------------------------------------------
__int64 __fastcall print_status(__int64 a1) {
  unsigned __int64 i;  // [rsp+18h] [rbp-8h]

  if (*(int *)(a1 + 36) > 783926) {
    printf(
        "Candidate cannot have more votes than the population of North Dakota "
        "(%d).\nResetting vote count to 0.\n",
        783926LL);
    *(_DWORD *)(a1 + 36) = 0;
  }
  if (!strncmp((const char *)a1, "Total", 5uLL)) {
    *(_DWORD *)(a1 + 36) = 0;
    for (i = 1LL; i < num_cands; ++i)
      *(_DWORD *)(a1 + 36) += *(_DWORD *)(cand_array + (i << 6) + 36);
  }
  print_int_with_commas(a1 + 40, 15, *(_DWORD *)(a1 + 36));
  return (*(__int64(__fastcall **)(__int64))(a1 + 56))(a1);
}
// 5050: using guessed type __int64 cand_array;
// 5058: using guessed type __int64 num_cands;

//----- (0000000000001E2F) ----------------------------------------------------
__int64 add_votes_menu() {
  __int64 result;      // rax
  int v1;              // [rsp+0h] [rbp-10h]
  unsigned __int64 i;  // [rsp+8h] [rbp-8h]

  v1 = 0;
  while (1) {
    result = num_cands;
    if (v1 == num_cands) break;
    printf("Select a candidate to add votes to, or %zu to return\n", num_cands);
    for (i = 1LL; i < num_cands; ++i)
      printf("%zu): %s\n", i, (const char *)(cand_array + (i << 6)));
    v1 = menu((const char *)&off_325E, "Incorrect value, try again\n> ",
              num_cands);
    if (v1 < (unsigned __int64)num_cands)
      *(_DWORD *)(cand_array + ((__int64)v1 << 6) + 36) +=
          menu("Enter the votes to add\n> ",
               "Too many votes, can't have more than the population of North "
               "Dakota\n> ",
               783926);
  }
  return result;
}
// 325E: using guessed type void *__ptr32 off_325E;
// 5050: using guessed type __int64 cand_array;
// 5058: using guessed type __int64 num_cands;

//----- (0000000000001F56) ----------------------------------------------------
unsigned __int64 set_new_password() {
  char v1[24];          // [rsp+0h] [rbp-20h] BYREF
  unsigned __int64 v2;  // [rsp+18h] [rbp-8h]

  v2 = __readfsqword(0x28u);
  printf("Please enter new password\n> ");
  __isoc99_scanf("%16c", v1);
  change_password_to(v1);
  return v2 - __readfsqword(0x28u);
}
// 11C0: using guessed type __int64 __isoc99_scanf(const char *, ...);

//----- (0000000000001FC3) ----------------------------------------------------
int close_voting() {
  __int64 v1;          // [rsp+0h] [rbp-10h]
  unsigned __int64 i;  // [rsp+8h] [rbp-8h]

  v1 = cand_array + 64;
  for (i = 1LL; i < num_cands; ++i) {
    if (*(_DWORD *)(v1 + 36) < *(_DWORD *)(cand_array + (i << 6) + 36))
      v1 = cand_array + (i << 6);
  }
  printf(
      "Voting is now closed! The winner is %s with %d votes!\nThis program "
      "will now exit.\n",
      (const char *)v1, *(unsigned int *)(v1 + 36));
  return system("/bin/sh");
}
// 5050: using guessed type __int64 cand_array;
// 5058: using guessed type __int64 num_cands;

//----- (0000000000002064) ----------------------------------------------------
void __noreturn main_menu() {
  int v0;              // [rsp+4h] [rbp-Ch]
  unsigned __int64 i;  // [rsp+8h] [rbp-8h]

  puts(
      "Welcome to the North Dakota Vote Tallying Software\nPresented by Jeff!");
  while (1) {
    while (1) {
      v0 = menu(
          "Please select an option:\n"
          "1) Enter votes for a candidate\n"
          "2) View current vote totals\n"
          "3) Close voting and display the winner (requires password)\n"
          "4) Change password (requires password)\n"
          "> ",
          "Incorrect value, try again\n> ", 5);
      if (v0 != 4) break;
      if ((unsigned int)check_password()) set_new_password();
    }
    if (v0 > 4) {
    LABEL_18:
      puts(
          "This should be unreachable, so there's nothing here. Congrats for "
          "finding it though!");
    } else if (v0 == 3) {
      if ((unsigned int)check_password()) close_voting();
    } else {
      if (v0 > 3) goto LABEL_18;
      if (v0 == 1) {
        add_votes_menu();
      } else {
        if (v0 != 2) goto LABEL_18;
        for (i = 0LL; i < num_cands; ++i) {
          print_status(cand_array + (i << 6));
          puts(byte_3451);
        }
      }
    }
  }
}
// 5050: using guessed type __int64 cand_array;
// 5058: using guessed type __int64 num_cands;

//----- (0000000000002180) ----------------------------------------------------
void term_proc() { ; }

// nfuncs=66 queued=36 decompiled=36 lumina nreq=0 worse=0 better=0
// ALL OK, 36 function(s) have been successfully decompiled
